<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoices</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; }
        #loadDataBtn {
            padding: 10px 15px;
            background-color: #007bff;
            border: none;
            color: white;
            cursor: pointer;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        #loadDataBtn:hover {
            background-color: #0056b3;
        }
        body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    #invoiceTable {
        width: 100% !important;
        table-layout: auto;
        word-wrap: break-word;
    }
    #invoiceTable th, #invoiceTable td {
        white-space: nowrap;
        text-align: left;
    }
    div.dataTables_wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .summary-card {
    flex: 1 1 200px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: #f9f9f9;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .summary-card h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        font-weight: bold;
    }
    .summary-card p {
        margin: 4px 0;
        font-size: 14px;
    }
    </style>
</head>
<body>
    <h1>Invoices</h1>
    <a href="/">Home</a>
    <!-- Summary Section -->
    <div id="summaryBox" style="display:flex; flex-wrap:wrap; gap:20px; margin:20px 0;">
        <!-- Cards will be filled dynamically -->
    </div>
    <button id="loadDataBtn">Load Invoices</button>
    <!-- Add this just below Load Invoices button -->
    <div id="filters" style="margin:10px 0;">
        <label>Order Date From: <input type="date" id="start_order_date"></label>
        <label>To: <input type="date" id="end_order_date"></label>
        <label>Payment Date From: <input type="date" id="start_payment_date"></label>
        <label>To: <input type="date" id="end_payment_date"></label>
    </div>

<div id="columnCheckboxes" style="margin:10px 0;"></div>
<div id="errorBox" style="color:red; margin:10px 0;"></div>

    <div id="loader" style="color:green"></div>
    <table id="invoiceTable" class="display">
        <thead>
            <tr id="tableHeadRow"></tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script>
        
    $(document).ready(function() {
        let table;

        $('#loadDataBtn').on('click', function() {
            $("#loader").html("Loading ........")

            // build API url with filters
            let url = '/api/list/Paymentsinvoices?';
            url += `start_order_date=${$('#start_order_date').val()}&end_order_date=${$('#end_order_date').val()}&`;
            url += `start_payment_date=${$('#start_payment_date').val()}&end_payment_date=${$('#end_payment_date').val()}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        alert("No data found");
                        $("#loader").html("");
                        return;
                    }
                    buildSummary(data);
                    // Clear existing table if reloading
                    if (table) {
                        table.destroy();
                        $('#invoiceTable thead tr').empty();
                        $('#invoiceTable tbody').empty();
                    }

                    $("#errorBox").html(""); // clear previous errors

                    // Default fields
                    const defaultFields = [
                        "order_id", "final_settlement_amount", "dispatch_date",
                        "payment_type", "payment_date", "order_status",
                        "listing_price", "shipping_charge", "customer_name", "state"
                    ];

                    // Build table headers from keys of first row
                    const keys = Object.keys(data[0]);

                    // Check missing defaults
                    const missing = defaultFields.filter(f => !keys.includes(f));
                    if (missing.length > 0) {
                        $("#errorBox").html("Missing required fields: " + missing.join(", "));
                        $("#loader").html("");
                        return;
                    }

                    keys.forEach(key => {
                        $('#invoiceTable thead tr').append(`<th>${key}</th>`);
                    });

                    // Build table rows
                    const rows = data.map(row => keys.map(k => row[k] || ''));

                    // Initialize DataTable
                    table = $('#invoiceTable').DataTable({
                        data: rows,
                        columns: keys.map(k => ({ title: k })),
                        pageLength: 25
                    });

                    // Build checkboxes dynamically
                    $('#columnCheckboxes').empty();
                    keys.forEach(key => {
                        const checked = defaultFields.includes(key) ? "checked" : "";
                        $('#columnCheckboxes').append(
                            `<label style="margin-right:10px;">
                                <input type="checkbox" class="colToggle" data-col="${key}" ${checked}> ${key}
                            </label>`
                        );
                    });

                    // Apply default visibility
                    keys.forEach((key, idx) => {
                        if (!defaultFields.includes(key)) {
                            table.column(idx).visible(false);
                        }
                    });

                    // Column toggle handler
                    $('.colToggle').on('change', function() {
                        const colName = $(this).data('col');
                        const colIdx = keys.indexOf(colName);
                        const column = table.column(colIdx);
                        if (this.checked) {
                            column.visible(true);
                        } else {
                            column.visible(false);
                        }
                    });

                    $("#loader").html("");
                })
                .catch(err => {
                    console.error('Error loading data:', err);
                    $("#loader").html("");
                });
        });
    });
    </script>



    <script>
// After fetch success, before table rendering
function buildSummary(data) {
    let totalBills = data.length;

    // Group counts
    let statusCounts = { delivered: 0, return: 0, rto: 0 };
    let totalListing = 0, totalSettlement = 0, totalShipping = 0;
    let paymentCounts = { cod: 0, prepaid: 0 };
    let invoiceDates = [], paymentDates = [];

    data.forEach(row => {
        // order_status
        if (row.order_status) {
            const st = row.order_status.toLowerCase();
            if (st.includes("delivered")) statusCounts.delivered++;
            if (st.includes("return")) statusCounts.return++;
            if (st.includes("rto")) statusCounts.rto++;
        }

        // totals
        totalListing += parseFloat(row.listing_price) || 0;
        totalSettlement += parseFloat(row.final_settlement_amount) || 0;
        totalShipping += parseFloat(row.shipping_charge) || 0;

        // payment_type
        if (row.payment_type) {
            const pt = row.payment_type.toLowerCase();
            if (pt === "cod") paymentCounts.cod++;
            if (pt.includes("prepaid")) paymentCounts.prepaid++;
        }

        // invoice_date range
        if (row.invoice_date) invoiceDates.push(new Date(row.invoice_date));
        // payment_date range
        if (row.payment_date) paymentDates.push(new Date(row.payment_date));
    });

    // Min/Max dates
    let invoiceRange = invoiceDates.length ? 
        `${new Date(Math.min(...invoiceDates)).toLocaleDateString()} → ${new Date(Math.max(...invoiceDates)).toLocaleDateString()}` : "N/A";

    let paymentRange = paymentDates.length ? 
        `${new Date(Math.min(...paymentDates)).toLocaleDateString()} → ${new Date(Math.max(...paymentDates)).toLocaleDateString()}` : "N/A";

    // Build cards
    let html = `
        <div class="summary-card">
            <h3>Total Bills</h3>
            <p>${totalBills}</p>
        </div>
        <div class="summary-card">
            <h3>Order Status</h3>
            <p>Delivered: ${statusCounts.delivered}</p>
            <p>Return: ${statusCounts.return}</p>
            <p>RTO: ${statusCounts.rto}</p>
        </div>
        <div class="summary-card">
            <h3>Totals</h3>
            <p>Listing Price: ${totalListing.toFixed(2)}</p>
            <p>Final Settlement: ${totalSettlement.toFixed(2)}</p>
            <p>Shipping Charges: ${totalShipping.toFixed(2)}</p>
        </div>
        <div class="summary-card">
            <h3>Payment Types</h3>
            <p>COD: ${paymentCounts.cod}</p>
            <p>Prepaid: ${paymentCounts.prepaid}</p>
        </div>
        <div class="summary-card">
            <h3>Invoice Dates</h3>
            <p>${invoiceRange}</p>
        </div>
        <div class="summary-card">
            <h3>Payment Dates</h3>
            <p>${paymentRange}</p>
        </div>
    `;

    $("#summaryBox").html(html);
}

// Call this function after successful fetch

</script>
</body>
</html>
